<html>

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="css/fontawesome/css/all.css" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">

    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script lang="text/javascript" src="https://unpkg.com/simple-web-serial@latest/dist/simple-serial.min.js"></script>
    <script src="js/chart.min.js"></script>
    <script src="js/luxon.min.js"></script>
    <script src="js/chartjs-adapter-luxon.js"></script>
    <script src="js/chartjs-plugin-streaming.js"></script>
    <script src="js/idb-keyval.min.js"></script>

    <title>DAQari - Browser-based Serial-DAQ Solution</title>
<script>

function dontLeave() {
  return "Please, don't leave!";
}
      </script>
  </head>
  <body onbeforeunload="return dontLeave()">
    <div class="w-100 p-2">
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h3 class="card-title"><img src="images/logo.svg" style="height: 1.75rem;"></img> DAQari</h3>
                <h6 class="card-subtitle mb-2 text-muted">Browser-based data acquisition</h6>
                <button class="btn btn-success btn-lg m-1 mb-4 mx-auto" id="connectButton"><i class="fas fa-plug"></i> Connect</button>
                <h6 class="card-subtitle mb-2 text-muted"><i class="far fa-copyright"></i> Nicholas Ravanelli, PhD</h6>
              </div>
              <div class="col-md-6">
                <div class="input-group mb-3" id="filename-input">
                  <input type="text" class="form-control form-control-sm" id="file-name-text" placeholder="Create file...">
                  <span class="input-group-text" id="file-url-icon"><i class="fas fa-file-medical-alt"></i></span>
                </div>
                <div class="input-group mb-3 w-50">
                  <input type="number" step="1" class="form-control form-control-sm logdata-settings" placeholder="Saving interval (default is 5 sec)" id="datalogInterval">
                  <span class="input-group-text" id="secondsinput-unit">seconds</span>
                </div>
                <div class="input-group mb-3">
                  <span class="input-group-text" id="basic-addon1">Insert Comment:</span>
                  <textarea class="form-control form-control-sm logdata-settings" placeholder="Comment"></textarea>
                  <button class="btn btn-outline-secondary" type="button" id="submitComment">Submit</button>
                </div>
                <div class="form-check form-switch w-100">
                  <input class="form-check-input logdata-settings" type="checkbox" id="LogdataSwitch" disabled>
                  <label class="form-check-label" for="Logdata">Save data</label>
                </div>
              </div>
          </div>
        </div>
      </div>

        <div id="DAQ-charts" class="mt-2"></div>

      </div>
    <script>
    // Global variables
    let fileHandle;
    let recordingData = false;
    let lastloggedDate = 0;
    let ChannelconfigArray = [];

    $("#LogdataSwitch").change(function(){
        if ($(this).is(':checked')){
          recordingData = true;
        }else{
          recordingData = false;
        }
      });

    $('#filename-input').click(async () => {
      try {
      var date = new Date().toISOString();
      var filenamesuggest = 'DAQari_'+date+'.txt';
              const options = {
                suggestedName: filenamesuggest,
                types: [
                  {
                    description: 'Text Files',
                    accept: {
                      'text/plain': ['.txt'],
                    },
                  },
                ],
              };
          fileHandle = await window.showSaveFilePicker(options);
          await idbKeyval.set("datalogfile", fileHandle);
          $('#file-name-text').val(fileHandle.name);
          $('.logdata-settings').prop("disabled", false);
        } catch (error) {
          console.log(error.name, error.message);
        }
    });


    var serialConnect = false;
      $('#connectButton').click(function(){

        const conn = SimpleSerial.connect({
            requestButton: 'connectButton'
          });


        conn.on("data", function(data) {
          if(serialConnect == false){
            var channelCount = Object.keys(data).length;
            drawGraph(data,'serialChannel');
            serialConnect = true;
          }
          window['serialChannel'] = data;


          for (var i in data) {
            var value = data[i];
            //lets check if there are specific settings on this channel:
            if(ChannelconfigArray['serialChannel'] && typeof ChannelconfigArray['serialChannel'][i] !== 'undefined'){
               if(ChannelconfigArray['serialChannel'][i]['transform'] === 'on'){
                 value = TransformData(ChannelconfigArray['serialChannel'][i],'serial-in',value);
               }
               //change title if set
               var channelName = ChannelconfigArray['serialChannel'][i]['serialChannel-Name'];
               var currentChannelName = $('#serialChannel-'+i+'-title').text();
               if(channelName !== currentChannelName){
                 $('#serialChannel-'+i+'-title').text(channelName);
               }
               //change units if Set
               var channelUnit = ChannelconfigArray['serialChannel'][i]['serialChannel-Unit'];
               var currentChannelUnit = $('#serialChannel-'+i+'-unit').text();
               if(channelName !== currentChannelName){
                 $('#serialChannel-'+i+'-unit').text(channelUnit);
               }
            }

            document.getElementById('serialChannel-value-'+i).innerHTML = value;
          };

          //save data if needed
          let timenow = getTimeValue();
          let interval = $("#datalogInterval").val();
            if(!interval){ interval = 5;}
          if((timenow - lastloggedDate) >= interval && recordingData){
                      saveData(timenow);
          }
        })

      });

      function getTimeValue() {
        var Time = Math.floor(Date.now() / 1000)
        return Time;
      }

      async function saveData(time) {
        lastloggedDate = time;
        //write to datalog file
        // Get the current file size.
          const writableStream = await fileHandle.createWritable({ keepExistingData: true });
          const size = (await fileHandle.getFile()).size;
          var dataset = window['serialChannel'];

          let output = time+',';
          for (var key in dataset) {
              output += dataset[key]+',';
          }

          await writableStream.write({
            type: "write",
            data: output+" \r\n",
            position: size,
          });
          await writableStream.close();

      }


      function serialChannel_SettingsModal(ch){
        $('#serialChannel-SettingsLabel').html("Serial Channel: "+ch);
        $('#serialChannel-id').val(ch);
        var Modal = new bootstrap.Modal(document.getElementById('ChannelSettings'));
        Modal.show();
      }


      function drawGraph(data,origin){

        //lets first draw all serial inputs
        for (const i in data) {
          var graphdiv = origin+'-'+i;
          //Create chart div
          var charthtml = '<div class="card mb-2 draggable-graph-div" draggable="true"><channel-info data-channeltype="'+origin+'" data-channelid="'+i+'"/><div class="card-body"><div class="row w-100"><h6 class="card-title"> <a data-bs-toggle="collapse" href="#'+origin+'-collapse-'+i+'" class="link-secondary collapse-icon" role="button"><i class="far fa-minus-square"></i></a> <a class="link-secondary" role="button" onclick="'+origin+'_SettingsModal('+i+')";><i class="fas fa-cog"></i></a> '+origin+' '+i+'; <span id="'+origin+'-'+i+'-title" class="text-danger"></span> <i>Value: <span id="'+origin+'-value-'+i+'"></span> <span id="'+origin+'-'+i+'-unit"></span></i> </h6></div><div class="row w-100 collapse show" id="'+origin+'-collapse-'+i+'"><canvas id="'+graphdiv+'" style="max-height:100px"></canvas></div></div></div>';
          $("#DAQ-charts").append(charthtml);

          //Chartjs create config
          const data = {
              datasets: [
                {
                  label: origin+' '+i,
                  data: [],
                  borderColor: 'rgb(75, 192, 192)',
                }
              ]
            };
          const config = {
              type: 'line',
              data: data,
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: false,
                },
                elements: {
                    point:{
                        radius: 0
                    }
                },
                scales: {
                  x: {
                    type: 'realtime',
                    realtime: {
                      duration: 20000,
                      refresh: 100,
                      delay: 100,
                      onRefresh: chart => {
                          const now = Date.now();
                          // append the new data array to the existing chart data
                          let value = window[origin][i];

                          if(ChannelconfigArray[origin] && typeof ChannelconfigArray[origin][i] !== 'undefined' && ChannelconfigArray[origin][i]['transform'] === 'on'){
                              value = TransformData(ChannelconfigArray[origin][i],origin,value);
                          }
                          chart.data.datasets[0].data.push({
                            x : now,
                            y : value
                          });
                        }
                    }
                  },
                  y: {
                    title: {
                      display: false,
                    }
                  }
                },
                interaction: {
                  intersect: false
                }
              }
            };
          var ctx = document.getElementById(graphdiv).getContext('2d');
           window[origin+'-Chartjs-' + i ] = new Chart(ctx, config);

        }
        MakeDraggable();
      }

async function UpdateConfig(){
  //clear Global config array and rewrite with all setting data from localdb
  ChannelconfigArray = [];
    await idbKeyval.entries().then((entries) => {
      for (var i=0 , j = entries.length ; i < j ;i++){
        let item = entries[i][0];
        let def = item.split('_');
        if(def[0] == 'serialChannel'){
            let channel = def[1];
            console.log(item);
            if (!ChannelconfigArray['serialChannel']) ChannelconfigArray['serialChannel'] = [];
            ChannelconfigArray['serialChannel'][channel] = entries[i][1];
        }
        if(def[0] == 'userChannel'){
            let channel = def[1];
            if (!ChannelconfigArray['userChannel']) ChannelconfigArray['userChannel'] = [];
            ChannelconfigArray['userChannel'][channel] = entries[i][1];
        }
      }
    }
  );
      console.log(ChannelconfigArray);
}

function redrawGraph(i,origin){
  var graphdiv = origin+'-'+i;
  const data = {
      datasets: [
        {
          label: origin+' '+i,
          data: [],
          borderColor: 'rgb(75, 192, 192)',
        }
      ]
    };
  const config = {
      type: 'line',
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: false,
        },
        elements: {
            point:{
                radius: 0
            }
        },
        scales: {
          x: {
            type: 'realtime',
            realtime: {
              duration: 20000,
              refresh: 100,
              delay: 100,
              onRefresh: chart => {
                  const now = Date.now();
                  // append the new data array to the existing chart data
                  let value = window[origin][i];

                  if(ChannelconfigArray[origin] && typeof ChannelconfigArray[origin][i] !== 'undefined' && ChannelconfigArray[origin][i]['transform'] === 'on'){
                      value = TransformData(ChannelconfigArray[origin][i],origin,value);
                  }
                  chart.data.datasets[0].data.push({
                    x : now,
                    y : value
                  });
                }
            }
          },
          y: {
            title: {
              display: false,
            }
          }
        },
        interaction: {
          intersect: false
        }
      }
    };
  var ctx = document.getElementById(graphdiv).getContext('2d');
   window[origin+'-Chartjs-' + i ] = new Chart(ctx, config);

}

function TransformData(array,type,rawvalue){
    var xvalues = [];
    var yvalues = [];
    xvalues.push(array['low-pc-input']);
    yvalues.push(array['low-pc-input-equivalent']);
    xvalues.push(array['high-pc-input']);
    yvalues.push(array['high-pc-input-equivalent']);
    var regressiontype = array.transformtype;
        switch (regressiontype){
          case "linear":
          default:
              var result = linearRegression(yvalues,xvalues);
              var value = result['slope'] * rawvalue + result['intercept'];
              return value;
      }
}

$(document).ready(function() {
  //get last used config from localdb
  UpdateConfig();

  $('#serialChannelSettings-submit-btn').click(async () => {
          var data = $('#serialChannel-Settings-form').serializeArray().reduce(function(obj, item) {
                        obj[item.name] = item.value;
                        return obj;
                    }, {});
          for (var key in data){
            if(!data[key]){
              $('#'+key).addClass('error-input');
              $('#rawinputsetting-submit-error').html('Error: missing data required.');
              return;
            }else{
              $('#'+key).removeClass('error-input');
            }
          }
          var localdbkey = 'serialChannel_'+data['serialChannel-id'];
          delete data['serialChannel-id'];
          await idbKeyval.set(localdbkey, data);
          UpdateConfig();
  });
});



$(document).on('click', '.collapse-icon', function () {
    $(this).find('i').toggleClass('fa-plus-square fa-minus-square');
});



//Regression Functions

function linearRegression(y,x){
        var lr = {};
        var n = y.length;
        var sum_x = 0;
        var sum_y = 0;
        var sum_xy = 0;
        var sum_xx = 0;
        var sum_yy = 0;

        for (var i = 0; i < y.length; i++) {

            sum_x += x[i];
            sum_y += y[i];
            sum_xy += (x[i]*y[i]);
            sum_xx += (x[i]*x[i]);
            sum_yy += (y[i]*y[i]);
        }

        lr['slope'] = (n * sum_xy - sum_x * sum_y) / (n*sum_xx - sum_x * sum_x);
        lr['intercept'] = (sum_y - lr.slope * sum_x)/n;
        lr['r2'] = Math.pow((n*sum_xy - sum_x*sum_y)/Math.sqrt((n*sum_xx-sum_x*sum_x)*(n*sum_yy-sum_y*sum_y)),2);

        return lr;
}


//draggable Graph divs
function MakeDraggable(){

      var dragSrcEl = null;

      function handleDragStart(e) {
        this.style.opacity = '0.4';

        dragSrcEl = this;

        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
      }

      function handleDragOver(e) {
        if (e.preventDefault) {
          e.preventDefault();
        }

        e.dataTransfer.dropEffect = 'move';

        return false;
      }

      function handleDragEnter(e) {
        this.classList.add('over');
      }

      function handleDragLeave(e) {
        this.classList.remove('over');
      }

      function handleDrop(e) {
        if (e.stopPropagation) {
          e.stopPropagation(); // stops the browser from redirecting.
        }
        if (dragSrcEl != this) {
          //store chart channel info to redraw them
          let graph1type = $(dragSrcEl).children('channel-info').data('channeltype');
          let graph1id = $(dragSrcEl).children('channel-info').data('channelid');
          let graph2type = $(this).children('channel-info').data('channeltype');
          let graph2id = $(this).children('channel-info').data('channelid');
          dragSrcEl.innerHTML = this.innerHTML;
          this.innerHTML = e.dataTransfer.getData('text/html');

          //destroy and redraw in new div
          window[graph1type+'-Chartjs-' + graph1id ].destroy();
          window[graph2type+'-Chartjs-' + graph2id ].destroy();
          redrawGraph(graph1id,graph1type);
          redrawGraph(graph2id,graph2type);
        }

        return false;
      }

      function handleDragEnd(e) {
        this.style.opacity = '1';

        items.forEach(function (item) {
          item.classList.remove('over');
        });
      }


      let items = document.querySelectorAll('#DAQ-charts .draggable-graph-div');

      items.forEach(function(item) {
        item.addEventListener('dragstart', handleDragStart, false);
        item.addEventListener('dragenter', handleDragEnter, false);
        item.addEventListener('dragover', handleDragOver, false);
        item.addEventListener('dragleave', handleDragLeave, false);
        item.addEventListener('drop', handleDrop, false);
        item.addEventListener('dragend', handleDragEnd, false);
      });
}

</script>

<!-- Modals -->
<div class="modal fade" id="ChannelSettings" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="serialChannel-SettingsLabel"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <form id="serialChannel-Settings-form">
          <input type="hidden" id="serialChannel-id" name="serialChannel-id" value="">

          <div class="mb-3">
            <label for="channelName" class="form-label">Channel Name:</label>
            <input type="text" class="form-control" id="serialChannel-Name" placeholder="Humidity" name="serialChannel-Name">
          </div>

          <label for="low-pc-input" class="form-label">Point Calibration (Low):</label>
          <div id="lowpointCalibrateHelp" class="form-text m-0">e.g. 0 V = 0 C</div>
          <div class="input-group mb-3">
            <input type="number" class="form-control" placeholder="0" id="low-pc-input" name="low-pc-input">
            <span class="input-group-text"> = </span>
            <input type="number" class="form-control" placeholder="0" id="low-pc-input-equivalent" name="low-pc-input-equivalent">
          </div>


          <label for="high-pc-input" class="form-label">Point Calibration (High):</label>
          <div id="highpointCalibrateHelp" class="form-text m-0">e.g. 5 V = 50 C</div>
          <div class="input-group mb-3">
            <input type="number" class="form-control" placeholder="5" id="high-pc-input" name="high-pc-input">
            <span class="input-group-text"> = </span>
            <input type="number" class="form-control" placeholder="50" id="high-pc-input-equivalent" name="high-pc-input-equivalent">
          </div>

          <div class="mb-3">
            <label for="channelUnit" class="form-label">Channel Units:</label>
            <input type="text" class="form-control" id="channelUnit" placeholder="%RH" name="serialChannel-Unit">
          </div>

          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="transformswitch" name="transform">
            <label class="form-check-label" for="transformswitch">Transform & Data Log</label>
          </div>

          <div class="mb-3">
            <label class="form-check-label" for="transformtype">Transformation Type:</label>
            <select class="form-select form-select-sm" id="transformtype" name="transformtype">
              <option selected value="linear">Linear</option>
            </select>
          </div>

        </form>

      </div>
      <div class="modal-footer">
        <span class="text-danger" id="rawinputsetting-submit-error"></span>
        <button type="button" class="btn btn-primary" id="serialChannelSettings-submit-btn">Save changes</button>
      </div>
    </div>
  </div>
</div>

  </body>
</html>
