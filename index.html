<html>

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="css/fontawesome/css/all.css" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script lang="text/javascript" src="https://unpkg.com/simple-web-serial@latest/dist/simple-serial.min.js"></script>

    <script src="js/chart.min.js"></script>
    <script src="js/luxon.min.js"></script>
    <script src="js/chartjs-adapter-luxon.js"></script>
    <script src="js/chartjs-plugin-streaming.js"></script>
    <script src="js/idb-keyval.min.js"></script>

    <title>DAQari V1.0</title>
<script>

function dontLeave() {
  return "Please, don't leave!";
}
      </script>
  </head>
  <body onbeforeunload="return dontLeave()">
    <div class="w-100 p-2">
        <div class="card">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h3 class="card-title">DAQari</h3>
                <h6 class="card-subtitle mb-2 text-muted">Browser-based data acquisition</h6>
                <button class="btn btn-success btn-lg m-1 mb-4 mx-auto" id="connectButton"><i class="fas fa-plug"></i> Connect</button>
                <h6 class="card-subtitle mb-2 text-muted"><i class="far fa-copyright"></i> Nicholas Ravanelli, PhD</h6>
              </div>
              <div class="col-md-6">
                <div class="input-group mb-3" id="filename-input">
                  <input type="text" class="form-control form-control-sm" id="file-name-text" placeholder="Create file...">
                  <span class="input-group-text" id="file-url-icon"><i class="fas fa-file-medical-alt"></i></span>
                </div>
                <div class="input-group mb-3 w-50">
                  <input type="number" step="1" class="form-control form-control-sm logdata-settings" placeholder="Saving interval (default is 5 sec)" id="datalogInterval">
                  <span class="input-group-text" id="secondsinput-unit">seconds</span>
                </div>
                <div class="input-group mb-3">
                  <span class="input-group-text" id="basic-addon1">Insert Comment:</span>
                  <textarea class="form-control form-control-sm logdata-settings" placeholder="Comment"></textarea>
                  <button class="btn btn-outline-secondary" type="button" id="submitComment">Submit</button>
                </div>
                <div class="form-check form-switch w-100">
                  <input class="form-check-input logdata-settings" type="checkbox" id="LogdataSwitch" disabled>
                  <label class="form-check-label" for="Logdata">Save data</label>
                </div>
              </div>
          </div>
        </div>
      </div>

        <div id="DAQ-charts" class="mt-2"></div>

      </div>
    <script>
    // File handle
    let fileHandle;
    let recordingData = false;
    let lastloggedDate = 0;

    $("#LogdataSwitch").change(function(){
        if ($(this).is(':checked')){
          recordingData = true;
        }else{
          recordingData = false;
        }
      });

    $('#filename-input').click(async () => {
      try {
      var date = new Date().toISOString();
      var filenamesuggest = 'DAQari_'+date+'.txt';
              const options = {
                suggestedName: filenamesuggest,
                types: [
                  {
                    description: 'Text Files',
                    accept: {
                      'text/plain': ['.txt'],
                    },
                  },
                ],
              };
          fileHandle = await window.showSaveFilePicker(options);
          await idbKeyval.set("datalogfile", fileHandle);
          $('#file-name-text').val(fileHandle.name);
          $('.logdata-settings').prop("disabled", false);
        } catch (error) {
          console.log(error.name, error.message);
        }
    });


    var serialConnect = false;
      $('#connectButton').click(function(){

        const conn = SimpleSerial.connect({
            requestButton: 'connectButton'
          });


        conn.on("data", function(data) {
          if(serialConnect == false){
            var channelCount = Object.keys(data).length;
            drawGraphs(channelCount);
            serialConnect = true;
          }
          window['serialdata'] = data;

          for (let index = 0; index < Object.keys(data).length; ++index) {
            document.getElementById('rawdata-channel-'+index).innerHTML = data[index];
          };

          //save data if needed
          let timenow = getTimeValue();
          let interval = $("#datalogInterval").val();
            if(!interval){ interval = 5;}
          if((timenow - lastloggedDate) >= interval && recordingData){
                      saveData(timenow);
          }
        })

      });
      function getTimeValue() {
        var Time = Math.floor(Date.now() / 1000)
        return Time;
      }

      async function saveData(time) {
        lastloggedDate = time;
        //write to datalog file
        // Get the current file size.
          const writableStream = await fileHandle.createWritable({ keepExistingData: true });
          const size = (await fileHandle.getFile()).size;
          var dataset = window['serialdata'];

          let output = time+',';
          for (var key in dataset) {
              output += dataset[key]+',';
          }

          await writableStream.write({
            type: "write",
            data: output+" \r\n",
            position: size // Set the position to the current file size.
          });
          await writableStream.close();

      }

      function drawGraphs(count){
        for (let i = 0; i < count; i++) {
          var graphdiv = 'ChartChannel-'+i;
          //Create chart div
          var charthtml = '<div class="card mb-2"><div class="card-body"><div class="row"><div class="col-2"><h6 class="card-title"><i class="fas fa-cog"></i> Channel '+i+'</h6><p class="lead" id="rawdata-channel-'+i+'"></p></div><div class="col-10"><canvas id="'+graphdiv+'" style="height:100px"></canvas></div></div></div></div>';
          $("#DAQ-charts").append(charthtml);

          //Chartjs create config
          const data = {
              datasets: [
                {
                  label: 'Channel '+i,
                  data: [],
                  borderColor: 'rgb(75, 192, 192)',
                }
              ]
            };
          const config = {
              type: 'line',
              data: data,
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: false,
                },
                elements: {
                    point:{
                        radius: 0
                    }
                },
                scales: {
                  x: {
                    type: 'realtime',
                    realtime: {
                      duration: 20000,
                      refresh: 500,
                      delay: 500,
                      onRefresh: chart => {
                          const now = Date.now();
                          // append the new data array to the existing chart data
                          chart.data.datasets[0].data.push({
                            x : now,
                            y : window['serialdata'][i]
                          });
                        }
                    }
                  },
                  y: {
                    title: {
                      display: false,
                    }
                  }
                },
                interaction: {
                  intersect: false
                }
              }
            };
          var ctx = document.getElementById(graphdiv).getContext('2d');
           window['RTChartChannel' + i ] = new Chart(ctx, config);

        }
      }



</script>
  </body>
</html>
